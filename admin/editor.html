<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Editor</title>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
textarea { width: 100%; height: 300px; font-family: monospace; }
button { padding: 8px 14px; background: #005f2b; color: white; border: none; cursor: pointer; }
.section { border-top: 2px solid #ccc; margin-top: 40px; padding-top: 20px; }
.review { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
</style>
</head>

<body>

<h1>Admin Editor</h1>

<!-- CONTENT -->
<h2>Edit Page Content</h2>
<select id="page">
  <option value="homepage">Homepage</option>
  <option value="products">Products</option>
</select>
<br><br>
<textarea id="editor"></textarea><br>
<button onclick="save()">Save & Build</button>

<!-- REVIEWS -->
<div class="section">
  <h2>Pending Reviews</h2>
  <div id="reviews">Loading...</div>
</div>

<!-- IMAGES -->
<div class="section">
  <h2>Upload Image</h2>
  <input type="file" id="image">
  <button onclick="uploadImage()">Upload</button>
  <p id="result"></p>
</div>

<script>
const editor = document.getElementById('editor');
const page = document.getElementById('page');
const reviewsBox = document.getElementById('reviews');

function loadPage() {
  fetch(`/content/${page.value}.yml`)
    .then(r => r.text())
    .then(t => editor.value = t);
}

function save() {
  try { jsyaml.load(editor.value); }
  catch (e) { return alert('YAML Error: ' + e.message); }

  fetch('/admin/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ page: page.value, yaml: editor.value })
  })
  .then(r => r.text())
  .then(alert);
}

function loadReviews() {
  fetch('/admin/pending-reviews')
    .then(r => r.json())
    .then(pending => {
      reviewsBox.innerHTML = '';

      // âœ… defensive check (prevents this error forever)
      if (!Array.isArray(pending) || pending.length === 0) {
        reviewsBox.innerHTML = 'No pending reviews';
        return;
      }

      pending.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'review';
        div.innerHTML = `
          <b>${r.name}</b><br>
          ${r.message}<br>
          <small>${r.date}</small><br><br>
          <button onclick="approve(${i})">Approve</button>
        `;
        reviewsBox.appendChild(div);
      });
    })
    .catch(err => {
      console.error(err);
      reviewsBox.innerHTML = 'Failed to load reviews';
    });
}


function approve(i) {
  fetch('/admin/approve-review', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ index: i })
  })
  .then(r => r.text())
  .then(msg => {
    alert(msg);
    loadReviews();
  });
}

function uploadImage() {
  const f = document.getElementById('image').files[0];
  if (!f) return alert('Select an image');

  const fd = new FormData();
  fd.append('image', f);

  fetch('/admin/upload-image', { method: 'POST', body: fd })
    .then(r => r.json())
    .then(r => {
      document.getElementById('result').innerText =
        'Uploaded. Use path: ' + r.path;
    });
}

page.onchange = loadPage;
window.onload = () => { loadPage(); loadReviews(); };
</script>

</body>
</html>
